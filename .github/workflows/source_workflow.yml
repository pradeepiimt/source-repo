name: Trigger Other Workflow
on:
  push:
    branches:
     - feature/pradeep
  workflow_run:
    workflows: ["Target Workflow"]
    repository: pradeepiimt/target-repo
    types:
      - completed  
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
  trigger_new_workflow:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_KEY }}
          owner: ${{ github.repository_owner }}
 
      # - name: Checkout Target Repo
      #   uses: actions/checkout@v2
      #   with:
      #     token:  ${{ steps.generate-token.outputs.token }}
      #     repository: pradeepiimt/target-repo
      - name: Trigger Target Workflow
        id: trigger_other_workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token:  ${{ steps.generate-token.outputs.token }}
          event-type: trigger-other-workflow
          repository: pradeepiimt/target-repo
          client-payload: '{"github": ${{ toJson(github) }}}'
          ref: feature/pradeep


      # Step 2: Wait for a few seconds for the triggered workflow to start
      - name: Wait for Workflow to Start
        run: sleep 30s

      # Step 3: Get the status of the triggered workflow
      - name: Get Workflow Run Status
        id: get_workflow_status
        run: |
          status=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ steps.generate-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs | jq -r '.status')
          echo "::set-output name=status::$status"

        # Step 4: Check if the status is completed
      - name: Check if Workflow Completed
        if: steps.get_workflow_status.outputs.status == 'completed'
        run: |
          echo "Target workflow has completed. Proceed with further actions."

      # Step 5: If not completed, perform actions for running workflow
      - name: Perform Actions for Running Workflow
        if: steps.get_workflow_status.outputs.status != 'completed'
        run: |
          echo "Target workflow is still running. Perform further actions if needed."
